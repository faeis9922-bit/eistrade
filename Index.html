<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EISGEMINI | TITANIUM EDITION</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://s3.tradingview.com/tv.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Rajdhani', 'sans-serif'],
                        cyber: ['Orbitron', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        neon: '#00ffcc',
                        neon_blue: '#00ccff',
                        neon_red: '#ff0055',
                        dark: '#050505',
                        panel: 'rgba(15, 15, 20, 0.95)'
                    },
                    animation: {
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'scan': 'scan line 3s linear infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* CORE STYLES */
        :root {
            --primary: #00ffcc;
            --secondary: #00ccff;
            --danger: #ff0055;
            --bg: #050505;
            --glass: rgba(20, 20, 25, 0.85);
        }

        body {
            background-color: var(--bg);
            background-image: 
                linear-gradient(rgba(0, 255, 204, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 204, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            color: #dcdcdc;
            overflow: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border: 1px solid #444; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* COMPONENTS */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
        }
        
        .cyber-border {
            position: relative;
            border: 1px solid rgba(0, 255, 204, 0.3);
        }
        .cyber-border::before {
            content: ''; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px;
            border-top: 2px solid var(--primary); border-left: 2px solid var(--primary);
        }
        .cyber-border::after {
            content: ''; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px;
            border-bottom: 2px solid var(--primary); border-right: 2px solid var(--primary);
        }

        .btn-neon {
            background: rgba(0, 255, 204, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }
        .btn-neon:hover {
            background: var(--primary);
            color: black;
            box-shadow: 0 0 20px var(--primary);
        }
        
        .loader-bar {
            width: 100%; height: 2px; background: #111; position: relative; overflow: hidden;
        }
        .loader-bar::after {
            content: ''; position: absolute; left: -50%; width: 50%; height: 100%;
            background: var(--primary);
            animation: load 1.5s infinite linear;
        }
        @keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

        /* UTILS */
        .text-glow { text-shadow: 0 0 10px currentColor; }
        .bg-grid-pattern {
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 10px 10px;
        }
    </style>
</head>
<body class="flex h-screen w-screen text-xs select-none font-sans">

    <aside class="w-72 flex flex-col glass-panel z-30 border-r border-white/5">
        <div class="p-6 border-b border-white/10 bg-black/40">
            <h1 class="text-3xl font-cyber font-bold tracking-widest text-center">
                EIS<span class="text-neon text-glow">GEMINI</span>
            </h1>
            <div class="flex justify-between mt-2 text-[9px] font-mono text-gray-500">
                <span>SYS: TITANIUM V.9.0</span>
                <span id="connection-status" class="text-red-500">● DISCONNECTED</span>
            </div>
        </div>

        <div class="flex border-b border-white/10">
            <button onclick="ui.switchTab('assets')" class="flex-1 py-3 hover:bg-white/5 text-gray-400 hover:text-white transition font-bold border-r border-white/5 active-tab" id="tab-assets">MARKET</button>
            <button onclick="ui.switchTab('history')" class="flex-1 py-3 hover:bg-white/5 text-gray-400 hover:text-white transition font-bold" id="tab-history">HISTORY</button>
        </div>

        <div id="panel-assets" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
            </div>

        <div id="panel-history" class="hidden flex-1 overflow-y-auto p-2 custom-scrollbar">
            <div class="text-[10px] text-gray-500 text-center py-2">LOCAL SIGNAL LOGS</div>
            <div id="history-list" class="space-y-2">
                </div>
        </div>

        <div class="p-4 border-t border-white/10 bg-black/20 space-y-2">
            <button onclick="app.toggleSettings()" class="w-full bg-white/5 border border-white/10 py-2 text-gray-300 hover:text-white hover:border-neon transition rounded flex items-center justify-center gap-2">
                <i class="fa-solid fa-key"></i> SYSTEM CONFIG
            </button>
            <div id="wallet-balance" class="text-center font-mono text-neon font-bold mt-2">$0.00 (SIM)</div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#080808]">
        
        <header class="h-14 glass-panel border-b border-white/5 flex items-center justify-between px-6 z-20">
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <h2 id="active-pair" class="text-2xl font-cyber font-bold text-white tracking-widest flex items-center gap-3">
                        SELECT ASSET <span class="text-[10px] bg-gray-800 px-2 py-0.5 rounded text-gray-400 font-sans">H1</span>
                    </h2>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <div class="text-[9px] text-gray-500 font-mono">AI PROCESSOR</div>
                    <div class="text-xs font-bold text-neon" id="ai-model-name">GEMINI 1.5 FLASH</div>
                </div>
                <button onclick="app.runAnalysis()" class="btn-neon px-6 py-2 font-bold font-cyber flex items-center gap-2">
                    <i class="fa-solid fa-microchip"></i> EXECUTE AI
                </button>
            </div>
        </header>

        <div class="flex-1 p-3 grid grid-cols-12 gap-3 overflow-hidden">
            
            <div class="col-span-12 lg:col-span-8 flex flex-col gap-3 h-full">
                <div class="flex-1 glass-panel cyber-border relative bg-black overflow-hidden">
                    <div id="tv-chart-container" class="absolute inset-0 z-0"></div>
                    <div id="chart-loader" class="absolute inset-0 bg-black z-10 flex items-center justify-center text-gray-500 font-mono hidden">
                        INITIALIZING CHART DATA...
                    </div>
                </div>
                
                <div class="h-8 glass-panel flex items-center px-3 overflow-hidden">
                    <div class="bg-neon/20 px-2 py-0.5 text-[9px] font-bold text-neon mr-3">LIVE NEWS</div>
                    <div class="whitespace-nowrap overflow-hidden w-full">
                        <div class="inline-block animate-[marquee_20s_linear_infinite] text-[10px] font-mono text-gray-400" id="news-ticker">
                            Waiting for market data stream... Global markets analyzing liquidity... Fed interest rate decision upcoming... Bitcoin volatility increasing...
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-4 flex flex-col gap-3 h-full overflow-y-auto pr-1 custom-scrollbar">
                
                <div class="glass-panel p-5 relative overflow-hidden group min-h-[220px]">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-robot text-7xl text-white"></i>
                    </div>
                    
                    <div class="relative z-10">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] font-bold text-gray-500 border border-gray-700 px-2 py-0.5 rounded">SIGNAL OUTPUT</span>
                            <span id="signal-time" class="text-[9px] text-gray-600 font-mono">--:--</span>
                        </div>
                        
                        <div class="flex items-center gap-4 my-2">
                            <div id="signal-text" class="text-5xl font-black font-cyber text-gray-600 drop-shadow-2xl">WAIT</div>
                        </div>

                        <div class="flex justify-between text-[10px] text-gray-400 mt-2">
                            <span>CONFIDENCE</span>
                            <span id="confidence-text">0%</span>
                        </div>
                        <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden mb-4 mt-1">
                            <div id="confidence-bar" class="h-full bg-gray-600 w-0 transition-all duration-1000 shadow-[0_0_10px_currentColor]"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-red-500/5 border border-red-500/20 p-2 rounded relative">
                                <div class="text-[8px] text-red-400 font-bold">STOP LOSS</div>
                                <div id="val-sl" class="text-sm font-mono font-bold text-white">-</div>
                            </div>
                            <div class="bg-green-500/5 border border-green-500/20 p-2 rounded relative">
                                <div class="text-[8px] text-green-400 font-bold">TAKE PROFIT</div>
                                <div id="val-tp" class="text-sm font-mono font-bold text-white">-</div>
                            </div>
                        </div>
                        <div class="mt-2 bg-blue-500/5 border border-blue-500/20 p-2 rounded flex justify-between items-center">
                            <span class="text-[8px] text-blue-400 font-bold">ENTRY</span>
                            <span id="val-entry" class="text-sm font-mono font-bold text-white">-</span>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-4">
                    <div class="flex items-center gap-2 mb-3 border-b border-white/5 pb-2">
                        <i class="fa-solid fa-calculator text-neon"></i>
                        <span class="font-bold text-gray-300">RISK CALCULATOR</span>
                    </div>
                    <div class="space-y-2 text-[10px]">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-gray-500 block mb-1">BALANCE ($)</label>
                                <input type="number" id="calc-balance" value="1000" class="w-full bg-black border border-gray-700 p-1.5 text-white rounded focus:border-neon outline-none">
                            </div>
                            <div>
                                <label class="text-gray-500 block mb-1">RISK (%)</label>
                                <input type="number" id="calc-risk" value="1" class="w-full bg-black border border-gray-700 p-1.5 text-white rounded focus:border-neon outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="text-gray-500 block mb-1">STOP LOSS (PIPS)</label>
                            <input type="number" id="calc-sl-pips" value="30" class="w-full bg-black border border-gray-700 p-1.5 text-white rounded focus:border-neon outline-none">
                        </div>
                        <button onclick="app.calculateRisk()" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-1.5 rounded transition font-bold mt-1">CALCULATE LOT</button>
                        
                        <div class="bg-neon/10 border border-neon/30 p-2 rounded flex justify-between items-center mt-2">
                            <span class="text-neon">LOT SIZE:</span>
                            <span id="calc-result" class="text-lg font-bold text-white font-mono">0.00</span>
                        </div>
                    </div>
                </div>

                <div class="glass-panel flex-1 flex flex-col overflow-hidden min-h-[150px]">
                    <div class="bg-[#111] px-3 py-1 border-b border-white/10 flex justify-between items-center">
                        <span class="text-[9px] font-mono text-neon">TERMINAL OUTPUT</span>
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    </div>
                    <div id="terminal-body" class="flex-1 p-3 font-mono text-[10px] text-green-400 overflow-y-auto leading-relaxed custom-scrollbar">
                        <div class="opacity-50">> System Initialized...</div>
                        <div class="opacity-50">> Waiting for user input...</div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="modal-settings" class="hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-6 rounded border border-neon/30 shadow-[0_0_50px_rgba(0,255,204,0.15)] relative">
            <button onclick="app.toggleSettings()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            
            <h3 class="text-xl font-cyber font-bold text-white mb-1"><i class="fa-solid fa-gear text-neon mr-2"></i>CONFIGURATION</h3>
            <p class="text-[10px] text-gray-500 mb-6 font-mono">SECURE API CONNECTION GATEWAY</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] text-neon mb-1 font-bold">GOOGLE GEMINI API KEY</label>
                    <input type="password" id="input-api-key" class="w-full bg-black/80 border border-gray-700 rounded p-3 text-white font-mono text-xs focus:border-neon focus:shadow-[0_0_10px_rgba(0,255,204,0.3)] outline-none transition" placeholder="Paste your AIza... key here">
                </div>
                
                <div class="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded text-[10px] text-yellow-500">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> Keys are stored locally in your browser. No data is sent to external servers except Google API.
                </div>

                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button onclick="app.saveConfig()" class="bg-neon text-black font-bold py-2.5 rounded hover:bg-white transition font-cyber tracking-widest">SAVE & CONNECT</button>
                    <button onclick="app.toggleSettings()" class="bg-gray-800 text-white font-bold py-2.5 rounded hover:bg-gray-700 transition font-cyber">CANCEL</button>
                </div>
                
                <div class="text-center mt-4">
                     <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[9px] text-gray-600 hover:text-neon underline">GET FREE API KEY</a>
                </div>
            </div>
        </div>
    </div>

    <div id="overlay-loading" class="hidden absolute inset-0 z-40 bg-black/95 backdrop-blur-md flex flex-col items-center justify-center">
        <div class="relative w-32 h-32">
            <div class="absolute inset-0 border-4 border-t-neon border-r-transparent border-b-purple-500 border-l-transparent rounded-full animate-spin"></div>
            <div class="absolute inset-4 border-4 border-t-transparent border-r-white border-b-transparent border-l-white rounded-full animate-[spin_3s_linear_infinite] opacity-50"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fa-solid fa-brain text-4xl text-neon animate-pulse"></i>
            </div>
        </div>
        <h2 class="mt-6 text-2xl font-cyber font-bold text-white tracking-[0.2em] animate-pulse">ANALYZING</h2>
        <div id="loading-step" class="mt-2 font-mono text-xs text-neon_blue">Connecting to Neural Network...</div>
        
        <div class="absolute bottom-10 left-0 w-full text-center opacity-30 pointer-events-none">
            <div class="font-mono text-[9px] text-green-500" id="matrix-code">
                Loading modules...
            </div>
        </div>
    </div>

    <script>
        // --- 1. SYSTEM CONFIGURATION ---
        const CONFIG = {
            assets: [
                { id: "XAUUSD", name: "Gold Spot", type: "COMMODITY", icon: "https://cdn-icons-png.flaticon.com/512/11520/11520626.png" },
                { id: "BTCUSD", name: "Bitcoin", type: "CRYPTO", icon: "https://cryptologos.cc/logos/bitcoin-btc-logo.png?v=025" },
                { id: "ETHUSD", name: "Ethereum", type: "CRYPTO", icon: "https://cryptologos.cc/logos/ethereum-eth-logo.png?v=025" },
                { id: "EURUSD", name: "Euro/USD", type: "FOREX", icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Flag_of_Europe.svg/1200px-Flag_of_Europe.svg.png" },
                { id: "GBPUSD", name: "GBP/USD", type: "FOREX", icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Flag_of_the_United_Kingdom_%281-2%29.svg/1200px-Flag_of_the_United_Kingdom_%281-2%29.svg.png" },
                { id: "USDJPY", name: "USD/JPY", type: "FOREX", icon: "https://upload.wikimedia.org/wikipedia/en/thumb/9/9e/Flag_of_Japan.svg/1200px-Flag_of_Japan.svg.png" },
                { id: "SOLUSD", name: "Solana", type: "CRYPTO", icon: "https://cryptologos.cc/logos/solana-sol-logo.png?v=025" },
                { id: "NAS100USD", name: "Nasdaq 100", type: "INDEX", icon: "https://cdn-icons-png.flaticon.com/512/2622/2622209.png" }
            ],
            apiModel: "gemini-1.5-flash"
        };

        // --- 2. CLASS: UI MANAGER ---
        class UIManager {
            constructor() {
                this.dom = {
                    assetList: document.getElementById('panel-assets'),
                    historyList: document.getElementById('history-list'),
                    terminal: document.getElementById('terminal-body'),
                    activePair: document.getElementById('active-pair'),
                    status: document.getElementById('connection-status'),
                    ticker: document.getElementById('news-ticker')
                };
            }

            renderAssets(list, activeId, callback) {
                this.dom.assetList.innerHTML = '';
                list.forEach(asset => {
                    const el = document.createElement('div');
                    const isActive = asset.id === activeId;
                    el.className = `p-3 mb-1 rounded cursor-pointer border-l-2 transition-all flex items-center justify-between group ${isActive ? 'bg-white/10 border-neon' : 'border-transparent hover:bg-white/5 hover:border-gray-500'}`;
                    el.onclick = () => callback(asset);
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${asset.icon}" class="w-8 h-8 rounded-full bg-white/10 p-0.5 object-cover">
                            <div>
                                <div class="font-bold text-gray-200 tracking-wide text-xs group-hover:text-white">${asset.id}</div>
                                <div class="text-[8px] text-gray-500 font-mono">${asset.name}</div>
                            </div>
                        </div>
                        <span class="text-[8px] font-bold px-1.5 py-0.5 rounded bg-black text-gray-500">${asset.type}</span>
                    `;
                    this.dom.assetList.appendChild(el);
                });
            }

            renderHistory(history) {
                this.dom.historyList.innerHTML = '';
                if(history.length === 0) {
                    this.dom.historyList.innerHTML = '<div class="text-center text-gray-600 italic text-[10px] mt-4">No analysis history found.</div>';
                    return;
                }
                
                [...history].reverse().forEach(item => {
                    const color = item.signal === 'BUY' ? 'text-neon' : (item.signal === 'SELL' ? 'text-neon_red' : 'text-gray-400');
                    const el = document.createElement('div');
                    el.className = 'bg-black/40 border border-white/5 p-2 rounded hover:border-white/20 transition';
                    el.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-[10px] text-white">${item.pair}</span>
                            <span class="text-[8px] text-gray-500">${item.time}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-cyber font-bold ${color}">${item.signal}</span>
                            <span class="text-[9px] font-mono text-gray-400">conf: ${item.confidence}%</span>
                        </div>
                    `;
                    this.dom.historyList.appendChild(el);
                });
            }

            log(msg, type = 'info') {
                const colors = { info: 'text-gray-400', success: 'text-neon', error: 'text-red-500', warning: 'text-yellow-500' };
                const time = new Date().toLocaleTimeString('en-US', {hour12:false});
                const line = document.createElement('div');
                line.className = `mb-1 ${colors[type] || colors.info} border-b border-white/5 pb-1`;
                line.innerHTML = `<span class="opacity-50 text-[8px]">[${time}]</span> ${msg}`;
                this.dom.terminal.appendChild(line);
                this.dom.terminal.scrollTop = this.dom.terminal.scrollHeight;
            }

            updateDashboard(data) {
                // Determine Colors
                const isBuy = data.signal === 'BUY';
                const isSell = data.signal === 'SELL';
                const colorClass = isBuy ? 'text-neon' : (isSell ? 'text-neon_red' : 'text-gray-500');
                const barClass = isBuy ? 'bg-neon shadow-[0_0_15px_#00ffcc]' : (isSell ? 'bg-neon_red shadow-[0_0_15px_#ff0055]' : 'bg-gray-600');

                // Update Text
                const sigText = document.getElementById('signal-text');
                sigText.innerText = data.signal;
                sigText.className = `text-5xl font-black font-cyber drop-shadow-2xl ${colorClass}`;
                if(isBuy || isSell) sigText.classList.add('animate-pulse');

                // Update Bar
                document.getElementById('confidence-text').innerText = data.confidence + '%';
                document.getElementById('confidence-text').className = colorClass;
                const bar = document.getElementById('confidence-bar');
                bar.className = `h-full transition-all duration-1000 ${barClass}`;
                bar.style.width = data.confidence + '%';

                // Update Values
                document.getElementById('val-entry').innerText = data.entry;
                document.getElementById('val-sl').innerText = data.sl;
                document.getElementById('val-tp').innerText = data.tp;
                document.getElementById('signal-time').innerText = new Date().toLocaleTimeString();
            }

            switchTab(tabName) {
                document.querySelectorAll('.active-tab').forEach(el => {
                    el.classList.remove('active-tab', 'border-r', 'border-white/5', 'text-white');
                    el.classList.add('text-gray-400');
                });
                document.getElementById('tab-' + tabName).classList.add('active-tab', 'border-r', 'border-white/5', 'text-white');
                document.getElementById('tab-' + tabName).classList.remove('text-gray-400');

                if(tabName === 'assets') {
                    document.getElementById('panel-assets').classList.remove('hidden');
                    document.getElementById('panel-history').classList.add('hidden');
                } else {
                    document.getElementById('panel-assets').classList.add('hidden');
                    document.getElementById('panel-history').classList.remove('hidden');
                }
            }

            setConnectionStatus(connected) {
                if(connected) {
                    this.dom.status.innerHTML = '<span class="animate-pulse">●</span> SYSTEM ONLINE';
                    this.dom.status.className = 'text-neon font-bold text-shadow';
                } else {
                    this.dom.status.innerHTML = '● DISCONNECTED';
                    this.dom.status.className = 'text-red-500';
                }
            }
        }

        // --- 3. CLASS: API MANAGER ---
        class APIManager {
            constructor() {
                this.apiKey = localStorage.getItem('EIS_TITANIUM_KEY') || '';
            }

            saveKey(key) {
                this.apiKey = key;
                localStorage.setItem('EIS_TITANIUM_KEY', key);
            }

            async fetchAnalysis(symbol) {
                if(!this.apiKey) throw new Error("API Key Missing");

                const prompt = `
                    Act as an institutional algo-trader. Analyze ${symbol}.
                    Current simulated market structure: Trending with high volatility.
                    
                    Return STRICT JSON ONLY. No markdown. No text before/after.
                    Format:
                    {
                        "signal": "BUY" or "SELL" or "NEUTRAL",
                        "confidence": number (50-99),
                        "entry": "price string",
                        "sl": "price string",
                        "tp": "price string",
                        "reason": "Technical reason under 15 words"
                    }
                    Mock realistic price values for ${symbol} current market.
                `;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.apiModel}:generateContent?key=${this.apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                const data = await response.json();
                
                if(data.error) throw new Error(data.error.message);
                if(!data.candidates || !data.candidates[0].content) throw new Error("Blocked by Safety Filter");

                // Clean JSON Logic (Robust)
                let text = data.candidates[0].content.parts[0].text;
                const start = text.indexOf('{');
                const end = text.lastIndexOf('}');
                
                if(start === -1 || end === -1) throw new Error("AI output invalid format");
                
                const jsonRaw = text.substring(start, end + 1);
                return JSON.parse(jsonRaw);
            }
        }

        // --- 4. CLASS: APP CONTROLLER ---
        class App {
            constructor() {
                this.ui = new UIManager();
                this.api = new APIManager();
                this.state = {
                    currentPair: CONFIG.assets[0],
                    history: JSON.parse(localStorage.getItem('EIS_HISTORY') || '[]')
                };
            }

            init() {
                this.ui.renderAssets(CONFIG.assets, this.state.currentPair.id, (asset) => this.selectAsset(asset));
                this.ui.renderHistory(this.state.history);
                this.loadChart(this.state.currentPair.id);
                this.checkStatus();
                
                // Init Log
                this.ui.log("System Boot Sequence Initiated...", "info");
                setTimeout(() => this.ui.log("UI Components Loaded.", "success"), 500);
                setTimeout(() => this.ui.log("Waiting for Secure API Handshake...", "warning"), 1000);
            }

            checkStatus() {
                if(this.api.apiKey) {
                    this.ui.setConnectionStatus(true);
                    this.ui.log("API Key Detected. Connection Secure.", "success");
                } else {
                    this.ui.setConnectionStatus(false);
                    this.ui.log("API Key Missing. System Limited.", "error");
                }
            }

            selectAsset(asset) {
                this.state.currentPair = asset;
                document.getElementById('active-pair').innerHTML = `${asset.id} <span class="text-[10px] bg-gray-800 px-2 py-0.5 rounded text-gray-400 font-sans">H1</span>`;
                this.ui.renderAssets(CONFIG.assets, asset.id, (a) => this.selectAsset(a));
                this.loadChart(asset.id);
                this.resetAnalysisUI();
                this.ui.log(`Switched asset to ${asset.id}`, "info");
            }

            loadChart(symbol) {
                const tvSymbol = symbol.includes("USD") ? symbol : `BINANCE:${symbol}`;
                const container = document.getElementById('tv-chart-container');
                container.innerHTML = ''; // clear
                
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/tv.js';
                script.onload = () => {
                    new TradingView.widget({
                        "autosize": true,
                        "symbol": tvSymbol,
                        "interval": "60",
                        "timezone": "Etc/UTC",
                        "theme": "dark",
                        "style": "1",
                        "locale": "en",
                        "toolbar_bg": "#f1f3f6",
                        "enable_publishing": false,
                        "hide_top_toolbar": false,
                        "container_id": "tv-chart-container",
                        "studies": ["RSI@tv-basicstudies", "MASimple@tv-basicstudies"]
                    });
                };
                container.appendChild(script);
            }

            toggleSettings() {
                const modal = document.getElementById('modal-settings');
                const isHidden = modal.classList.contains('hidden');
                if(isHidden) {
                    modal.classList.remove('hidden');
                    document.getElementById('input-api-key').value = this.api.apiKey;
                } else {
                    modal.classList.add('hidden');
                }
            }

            saveConfig() {
                const key = document.getElementById('input-api-key').value.trim();
                if(key) {
                    this.api.saveKey(key);
                    this.checkStatus();
                    this.toggleSettings();
                    this.ui.log("Configuration Saved. System Ready.", "success");
                }
            }

            async runAnalysis() {
                if(!this.api.apiKey) {
                    this.ui.log("Command Rejected: Missing API Key", "error");
                    this.toggleSettings();
                    return;
                }

                // Show Loader
                const overlay = document.getElementById('overlay-loading');
                const stepText = document.getElementById('loading-step');
                const matrix = document.getElementById('matrix-code');
                overlay.classList.remove('hidden');

                const steps = [
                    "Fetching Market Liquidity...", 
                    "Scanning Order Blocks...", 
                    "Calculating Fibonacci Retracement...", 
                    "Synthesizing Neural Output..."
                ];
                
                let stepIdx = 0;
                const interval = setInterval(() => {
                    if(stepIdx < steps.length) stepText.innerText = steps[stepIdx++];
                    matrix.innerHTML += Math.random().toString(36).substring(7) + " ";
                }, 800);

                try {
                    this.ui.log(`Starting analysis for ${this.state.currentPair.id}...`, "warning");
                    
                    const result = await this.api.fetchAnalysis(this.state.currentPair.id);
                    
                    clearInterval(interval);
                    overlay.classList.add('hidden');

                    this.ui.updateDashboard(result);
                    this.ui.log(`Analysis Complete. Signal: ${result.signal}`, "success");
                    this.ui.log(`Reason: ${result.reason}`, "info");

                    // Save History
                    this.saveHistory(result);

                } catch (error) {
                    clearInterval(interval);
                    overlay.classList.add('hidden');
                    alert("System Error: " + error.message);
                    this.ui.log("CRITICAL ERROR: " + error.message, "error");
                }
            }

            saveHistory(data) {
                const entry = {
                    pair: this.state.currentPair.id,
                    time: new Date().toLocaleTimeString(),
                    signal: data.signal,
                    confidence: data.confidence
                };
                this.state.history.push(entry);
                if(this.state.history.length > 20) this.state.history.shift(); // Keep last 20
                
                localStorage.setItem('EIS_HISTORY', JSON.stringify(this.state.history));
                this.ui.renderHistory(this.state.history);
            }

            calculateRisk() {
                const balance = parseFloat(document.getElementById('calc-balance').value);
                const risk = parseFloat(document.getElementById('calc-risk').value);
                const sl = parseFloat(document.getElementById('calc-sl-pips').value);
                
                if(balance && risk && sl) {
                    const riskAmount = balance * (risk / 100);
                    // Standard Lot approx formula (Simplified for general usage)
                    // Risk / (SL * PipValue). Assuming 10$ per pip per lot for simplicity in this demo
                    const lot = (riskAmount / (sl * 10)).toFixed(2);
                    
                    document.getElementById('calc-result').innerText = lot + " Lot";
                    document.getElementById('calc-result').className = "text-lg font-bold text-neon font-mono";
                    this.ui.log(`Calculator: Risk $${riskAmount.toFixed(1)} = ${lot} Lots`, "info");
                }
            }

            resetAnalysisUI() {
                document.getElementById('signal-text').innerText = "READY";
                document.getElementById('signal-text').className = "text-5xl font-black font-cyber text-gray-600 drop-shadow-2xl";
                document.getElementById('confidence-bar').style.width = "0%";
            }
        }

        // --- 5. INITIALIZATION ---
        const ui = new UIManager(); // Export for HTML onClick
        const app = new App();
        
        window.onload = () => {
            app.init();
        };

    </script>
</body>
</html>
