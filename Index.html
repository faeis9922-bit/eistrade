<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NamTrade AI - Ultimate Vision</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Prompt:wght@200;300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #030712;
            --bg-panel: rgba(17, 24, 39, 0.75);
            --primary: #00f0ff;  /* Cyan Neon */
            --secondary: #7000ff; /* Purple Neon */
            --success: #00ffa3;
            --danger: #ff003c;
            --warning: #facc15;
            --text-main: #f8fafc;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        /* --- Global Setup --- */
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Prompt', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .font-tech { font-family: 'Rajdhani', sans-serif; }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0b0f19; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }

        /* --- Background & Particles --- */
        #canvas-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at center, #111827 0%, #030712 100%);
        }

        /* --- Glassmorphism --- */
        .glass {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .glass-hover:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.2);
        }

        /* --- Glitch Logo Effect --- */
        .glitch-wrapper {
            position: relative;
            display: inline-block;
        }
        .glitch {
            font-size: 2.5rem;
            font-weight: 800;
            text-transform: uppercase;
            position: relative;
            color: white;
            letter-spacing: 2px;
        }
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        .glitch::before {
            left: 2px;
            text-shadow: -1px 0 #ff00c1;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch::after {
            left: -2px;
            text-shadow: -1px 0 #00fff9;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip: rect(38px, 9999px, 81px, 0); }
            20% { clip: rect(6px, 9999px, 14px, 0); }
            40% { clip: rect(69px, 9999px, 3px, 0); }
            60% { clip: rect(13px, 9999px, 76px, 0); }
            80% { clip: rect(50px, 9999px, 20px, 0); }
            100% { clip: rect(30px, 9999px, 93px, 0); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(15px, 9999px, 60px, 0); }
            20% { clip: rect(80px, 9999px, 5px, 0); }
            40% { clip: rect(20px, 9999px, 50px, 0); }
            60% { clip: rect(2px, 9999px, 85px, 0); }
            80% { clip: rect(60px, 9999px, 10px, 0); }
            100% { clip: rect(40px, 9999px, 30px, 0); }
        }

        /* --- Auth Animations --- */
        .auth-container {
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .switch-enter { animation: slide-in 0.5s forwards; }
        .switch-exit { animation: slide-out 0.5s forwards; }
        
        @keyframes slide-in {
            0% { opacity: 0; transform: translateX(50px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        @keyframes slide-out {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(-50px); }
        }

        /* --- Scanner Effect --- */
        .scan-line {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary), 0 0 30px var(--primary);
            opacity: 0.8;
            animation: scan 2s ease-in-out infinite;
            display: none;
            z-index: 20;
        }
        .scan-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent, rgba(0, 240, 255, 0.2));
            opacity: 0;
            animation: pulse-scan 2s ease-in-out infinite;
            display: none;
            z-index: 10;
        }
        @keyframes scan {
            0%, 100% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        @keyframes pulse-scan { 0%, 100% { opacity: 0; } 50% { opacity: 0.3; } }

        /* --- Buttons --- */
        .btn-cyber {
            position: relative;
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            overflow: hidden;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }
        .btn-cyber::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: var(--primary);
            transition: 0.3s;
            z-index: -1;
        }
        .btn-cyber:hover::before { left: 0; }
        .btn-cyber:hover { color: #000; box-shadow: 0 0 20px var(--primary); }

        .btn-action {
            background: linear-gradient(135deg, var(--primary), #00aaff);
            border: none;
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-action:active { transform: scale(0.95); box-shadow: 0 0 5px rgba(0, 240, 255, 0.4); }

        /* --- Result Cards --- */
        .result-card {
            border-left: 4px solid #555;
            transition: all 0.3s;
        }
        .result-card.buy { border-color: var(--success); background: linear-gradient(90deg, rgba(0,255,163,0.1), transparent); }
        .result-card.sell { border-color: var(--danger); background: linear-gradient(90deg, rgba(255,0,60,0.1), transparent); }
        .result-card.wait { border-color: var(--warning); background: linear-gradient(90deg, rgba(250,204,21,0.1), transparent); }

    </style>
</head>
<body>

    <canvas id="canvas-bg"></canvas>

    <section id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-md perspective-1000">
            
            <div class="text-center mb-8 animate-pulse">
                <div class="glitch-wrapper">
                    <h1 class="glitch font-tech" data-text="NAMTRADE">NAMTRADE</h1>
                </div>
                <p class="text-cyan-400 tracking-[0.5em] text-xs mt-2 uppercase">AI Vision Intelligence</p>
            </div>

            <div id="login-box" class="glass p-8 rounded-2xl auth-container relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent"></div>
                <h2 class="text-2xl font-bold text-white mb-6 font-tech"><i class="fa-solid fa-lock text-cyan-400 mr-2"></i>ACCESS TERMINAL</h2>
                
                <form onsubmit="event.preventDefault(); Auth.login();" class="space-y-5">
                    <div class="relative group">
                        <i class="fa-solid fa-user absolute left-4 top-3.5 text-slate-500 group-focus-within:text-cyan-400 transition"></i>
                        <input type="email" id="l-email" class="w-full bg-[#050911] border border-slate-700 rounded-lg py-3 pl-12 pr-4 text-white focus:border-cyan-500 focus:shadow-[0_0_10px_rgba(0,240,255,0.3)] outline-none transition" placeholder="Username / Email" required>
                    </div>
                    <div class="relative group">
                        <i class="fa-solid fa-key absolute left-4 top-3.5 text-slate-500 group-focus-within:text-cyan-400 transition"></i>
                        <input type="password" id="l-pass" class="w-full bg-[#050911] border border-slate-700 rounded-lg py-3 pl-12 pr-4 text-white focus:border-cyan-500 focus:shadow-[0_0_10px_rgba(0,240,255,0.3)] outline-none transition" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn-cyber w-full py-3.5 rounded-lg text-lg">
                        LOGIN SYSTEM
                    </button>
                </form>

                <div class="mt-6 text-center text-sm border-t border-white/10 pt-4">
                    <span class="text-slate-400">Access Restricted? </span>
                    <button onclick="Auth.toggle('register')" class="text-cyan-400 font-bold hover:text-white transition">Apply for Membership</button>
                </div>
            </div>

            <div id="register-box" class="glass p-8 rounded-2xl auth-container hidden relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-purple-500 to-transparent"></div>
                <h2 class="text-2xl font-bold text-white mb-6 font-tech"><i class="fa-solid fa-user-plus text-purple-400 mr-2"></i>NEW TRADER ID</h2>
                
                <form onsubmit="event.preventDefault(); Auth.register();" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" class="bg-[#050911] border border-slate-700 rounded-lg py-3 px-4 text-white focus:border-purple-500 outline-none" placeholder="First Name" required>
                        <input type="text" class="bg-[#050911] border border-slate-700 rounded-lg py-3 px-4 text-white focus:border-purple-500 outline-none" placeholder="Last Name">
                    </div>
                    <input type="email" id="r-email" class="w-full bg-[#050911] border border-slate-700 rounded-lg py-3 px-4 text-white focus:border-purple-500 outline-none" placeholder="Email Address" required>
                    <input type="password" id="r-pass" class="w-full bg-[#050911] border border-slate-700 rounded-lg py-3 px-4 text-white focus:border-purple-500 outline-none" placeholder="Create Password" required>
                    
                    <button type="submit" class="btn-cyber w-full py-3.5 rounded-lg text-lg !border-purple-500 !text-purple-400 hover:!text-black hover:bg-purple-500">
                        INITIALIZE ACCOUNT
                    </button>
                </form>

                <div class="mt-6 text-center text-sm border-t border-white/10 pt-4">
                    <span class="text-slate-400">Already authorized? </span>
                    <button onclick="Auth.toggle('login')" class="text-purple-400 font-bold hover:text-white transition">Return to Login</button>
                </div>
            </div>

        </div>
    </section>

    <div id="app-screen" class="hidden min-h-screen pb-24 transition-opacity duration-500 opacity-0">
        
        <header class="fixed top-0 w-full z-40 bg-[#030712]/80 backdrop-blur-md border-b border-white/10 px-4 h-16 flex items-center justify-between shadow-[0_4px_30px_rgba(0,240,255,0.1)]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-cyan-500/20 rounded flex items-center justify-center border border-cyan-500">
                    <i class="fa-solid fa-eye text-cyan-400 text-sm"></i>
                </div>
                <div>
                    <h1 class="font-tech font-bold text-lg leading-none tracking-wider">NAM<span class="text-cyan-400">VISION</span></h1>
                    <span class="text-[9px] text-slate-400 bg-slate-800 px-1 rounded block w-fit mt-0.5">PRO V.3.0</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <div id="user-name-display" class="text-xs font-bold text-slate-200">Trader</div>
                    <div class="text-[10px] text-green-400">‚óè SYSTEM ONLINE</div>
                </div>
                <button onclick="Settings.open()" class="w-10 h-10 rounded-full bg-slate-800/50 hover:bg-slate-700 border border-slate-600 text-cyan-400 transition flex items-center justify-center">
                    <i class="fa-solid fa-gear fa-spin-hover"></i>
                </button>
            </div>
        </header>

        <main class="pt-24 px-4 max-w-lg mx-auto space-y-6">

            <div id="api-alert" class="hidden bg-red-900/20 border border-red-500/50 p-3 rounded-lg flex items-center gap-3 animate-pulse cursor-pointer" onclick="Settings.open()">
                <i class="fa-solid fa-triangle-exclamation text-red-500 text-xl"></i>
                <div>
                    <h3 class="font-bold text-red-400 text-sm">MISSING API KEY</h3>
                    <p class="text-[10px] text-slate-300">Tap here to configure Gemini API Key.</p>
                </div>
            </div>

            <div class="glass p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 text-8xl text-white/5 font-tech select-none group-hover:text-cyan-400/5 transition">01</div>
                <label class="text-xs text-cyan-400 font-bold tracking-widest uppercase mb-3 block"><i class="fa-solid fa-crosshairs mr-1"></i> Target Asset</label>
                
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="App.setPair('XAUUSD')" class="pair-btn active bg-slate-800 border border-cyan-500 text-cyan-400 rounded-lg p-2 text-sm font-bold shadow-[0_0_10px_rgba(0,240,255,0.2)]">XAUUSD</button>
                    <button onclick="App.setPair('EURUSD')" class="pair-btn bg-slate-800/50 border border-slate-700 text-slate-400 hover:text-white rounded-lg p-2 text-sm font-bold">EURUSD</button>
                    <button onclick="App.setPair('BTCUSD')" class="pair-btn bg-slate-800/50 border border-slate-700 text-slate-400 hover:text-white rounded-lg p-2 text-sm font-bold">BTCUSD</button>
                </div>
                
                <div class="mt-3 relative">
                     <select id="custom-pair" class="w-full bg-[#050911] border border-slate-700 rounded-lg p-2 text-xs text-slate-300 focus:border-cyan-500 outline-none" onchange="App.setPair(this.value, true)">
                        <option value="">+ Select Other Asset</option>
                        <option value="GBPUSD">GBPUSD</option>
                        <option value="USDJPY">USDJPY</option>
                        <option value="USDTTHB">USDTTHB</option>
                        <option value="ETHUSD">ETHUSD</option>
                    </select>
                </div>
            </div>

            <div class="glass p-5 rounded-2xl relative">
                <div class="absolute -right-4 -top-4 text-8xl text-white/5 font-tech select-none">02</div>
                <label class="text-xs text-cyan-400 font-bold tracking-widest uppercase mb-3 block"><i class="fa-solid fa-eye mr-1"></i> Chart Vision</label>

                <div id="drop-zone" class="border-2 border-dashed border-slate-600 rounded-xl h-60 relative overflow-hidden flex flex-col items-center justify-center transition-all bg-[#050911]/50 group hover:border-cyan-500/50 cursor-pointer">
                    <input type="file" id="file-input" accept="image/*" class="absolute inset-0 opacity-0 z-20 cursor-pointer">
                    
                    <div id="scanner-line" class="scan-line z-30"></div>
                    <div id="scanner-overlay" class="scan-overlay z-20"></div>

                    <div id="upload-ui" class="text-center transition-opacity duration-300">
                        <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-3 shadow-inner group-hover:scale-110 transition">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl text-cyan-400"></i>
                        </div>
                        <h3 class="font-bold text-white">Upload Chart Image</h3>
                        <p class="text-[10px] text-slate-400 mt-1">Tap or Drag & Drop (JPG/PNG)</p>
                    </div>

                    <img id="img-preview" class="absolute inset-0 w-full h-full object-contain hidden z-10 bg-black">
                    <button id="btn-remove-img" onclick="App.clearImage()" class="absolute top-2 right-2 z-40 bg-red-500/80 text-white w-8 h-8 rounded-full hidden hover:bg-red-600"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <button id="btn-analyze" onclick="AI.analyze()" class="btn-action w-full py-4 rounded-xl text-xl uppercase tracking-widest relative overflow-hidden disabled:opacity-50 disabled:cursor-not-allowed group">
                <span class="relative z-10 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-microchip group-hover:animate-spin"></i> Analyze Market
                </span>
            </button>

            <div id="result-container" class="hidden opacity-0 transform translate-y-10 transition-all duration-500">
                
                <div class="flex justify-between items-center mb-2 px-2">
                    <span class="text-xs text-slate-400">AI CONFIDENCE SCORE</span>
                    <button onclick="AI.toggleLang()" class="text-[10px] border border-cyan-500 text-cyan-400 px-2 py-0.5 rounded uppercase hover:bg-cyan-500 hover:text-black transition">Switch Language</button>
                </div>

                <div class="glass p-0 rounded-2xl overflow-hidden shadow-2xl">
                    <div id="res-header" class="p-6 text-center bg-gradient-to-b from-slate-800 to-transparent border-b border-white/5 relative">
                        <div class="absolute top-0 left-0 w-full h-1 bg-slate-500" id="res-bar"></div>
                        <div class="text-sm text-slate-400 tracking-widest font-tech mb-1" id="res-pair">XAUUSD</div>
                        <h2 id="res-action" class="text-5xl font-bold font-tech text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">WAIT</h2>
                        <div id="res-conf" class="mt-2 inline-block px-3 py-1 rounded-full bg-black/30 border border-white/10 text-xs text-cyan-400">0% Confidence</div>
                    </div>

                    <div class="grid grid-cols-2 divide-x divide-white/10 border-b border-white/10">
                        <div class="p-4 text-center">
                            <span class="text-[10px] text-slate-500 uppercase block">Entry Zone</span>
                            <span id="res-entry" class="text-lg font-bold font-mono text-white">-</span>
                        </div>
                         <div class="p-4 text-center">
                            <span class="text-[10px] text-slate-500 uppercase block">Risk Ratio</span>
                            <span id="res-rr" class="text-lg font-bold font-mono text-white">-</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 divide-x divide-white/10 border-b border-white/10">
                        <div class="p-4 text-center bg-red-500/5">
                            <span class="text-[10px] text-red-400 uppercase block">Stop Loss</span>
                            <span id="res-sl" class="text-lg font-bold font-mono text-red-400">-</span>
                        </div>
                         <div class="p-4 text-center bg-green-500/5">
                            <span class="text-[10px] text-green-400 uppercase block">Take Profit</span>
                            <span id="res-tp" class="text-lg font-bold font-mono text-green-400">-</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 text-[10px] border-b border-white/10">
                        <div class="p-2 px-4 flex justify-between bg-green-900/10">
                            <span class="text-green-500">BUY ZONE:</span>
                            <span id="res-z-buy" class="text-slate-300">-</span>
                        </div>
                         <div class="p-2 px-4 flex justify-between bg-red-900/10 border-l border-white/10">
                            <span class="text-red-500">SELL ZONE:</span>
                            <span id="res-z-sell" class="text-slate-300">-</span>
                        </div>
                    </div>

                    <div class="p-5">
                        <h4 class="text-xs font-bold text-cyan-400 mb-2"><i class="fa-solid fa-robot"></i> AI REASONING</h4>
                        <p id="res-reason" class="text-sm text-slate-300 font-light leading-relaxed">-</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-fade-in">
        <div class="glass w-full max-w-sm rounded-2xl p-6 border-cyan-500/30 shadow-[0_0_50px_rgba(0,240,255,0.1)]">
            <h2 class="text-xl font-bold font-tech text-white mb-4"><i class="fa-solid fa-key text-cyan-400"></i> SYSTEM CONFIG</h2>
            
            <div class="mb-4">
                <label class="text-xs text-slate-400 block mb-2">GEMINI API KEY</label>
                <div class="relative">
                     <i class="fa-brands fa-google absolute left-3 top-3 text-slate-500"></i>
                    <input type="password" id="api-key-input" class="w-full bg-black/50 border border-slate-600 rounded-lg py-2.5 pl-10 pr-2 text-xs font-mono text-cyan-400 focus:border-cyan-500 outline-none" placeholder="Paste your key here...">
                </div>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-cyan-600 hover:text-cyan-400 mt-1 inline-block underline">Get Free API Key</a>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="Settings.save()" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white py-2 rounded-lg font-bold shadow-lg shadow-cyan-500/20">SAVE</button>
                <button onclick="Settings.close()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[110] w-max max-w-[90%]"></div>

    <script>
        // --- 1. SOUND ENGINE (Synthesizer) ---
        class SoundFX {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.enabled = true;
            }

            playTone(freq, type, duration, vol = 0.1) {
                if (!this.enabled) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }

            click() { this.playTone(800, 'sine', 0.1, 0.05); }
            hover() { this.playTone(400, 'triangle', 0.05, 0.02); }
            success() { 
                this.playTone(600, 'sine', 0.1, 0.1);
                setTimeout(() => this.playTone(1200, 'sine', 0.3, 0.1), 100);
            }
            error() { 
                this.playTone(150, 'sawtooth', 0.3, 0.1);
                setTimeout(() => this.playTone(100, 'sawtooth', 0.3, 0.1), 150);
            }
            scan() {
                if (!this.enabled) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(200, this.ctx.currentTime + 2);
                gain.gain.setValueAtTime(0.02, this.ctx.currentTime);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 2);
                return osc;
            }
        }
        const SFX = new SoundFX();

        // --- 2. PARTICLE BACKGROUND ---
        class ParticleSystem {
            constructor() {
                this.canvas = document.getElementById('canvas-bg');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.init();
                this.animate();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            init() {
                const count = Math.min(window.innerWidth / 10, 100);
                for(let i=0; i<count; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        vx: (Math.random() - 0.5) * 0.5,
                        vy: (Math.random() - 0.5) * 0.5,
                        size: Math.random() * 2 + 1
                    });
                }
            }

            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = 'rgba(0, 240, 255, 0.5)';
                this.ctx.strokeStyle = 'rgba(0, 240, 255, 0.1)';

                for (let i = 0; i < this.particles.length; i++) {
                    let p = this.particles[i];
                    p.x += p.vx;
                    p.y += p.vy;

                    if (p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
                    if (p.y < 0 || p.y > this.canvas.height) p.vy *= -1;

                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();

                    for (let j = i + 1; j < this.particles.length; j++) {
                        let p2 = this.particles[j];
                        let dx = p.x - p2.x;
                        let dy = p.y - p2.y;
                        let dist = Math.sqrt(dx*dx + dy*dy);

                        if (dist < 100) {
                            this.ctx.lineWidth = 1 - (dist/100);
                            this.ctx.beginPath();
                            this.ctx.moveTo(p.x, p.y);
                            this.ctx.lineTo(p2.x, p2.y);
                            this.ctx.stroke();
                        }
                    }
                }
                requestAnimationFrame(() => this.animate());
            }
        }
        new ParticleSystem();

        // --- 3. LOGIC MODULES ---

        // Toast Notification
        const Toast = {
            show(msg, type = 'info') {
                SFX.hover();
                const box = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = type === 'error' ? 'border-red-500 text-red-400' : (type === 'success' ? 'border-green-500 text-green-400' : 'border-cyan-500 text-cyan-400');
                const icon = type === 'error' ? 'fa-circle-xmark' : (type === 'success' ? 'fa-circle-check' : 'fa-circle-info');
                
                el.className = `glass mb-2 px-4 py-3 rounded-lg border-l-4 ${colors} flex items-center gap-3 shadow-lg animate-[slide-in_0.3s_ease-out]`;
                el.innerHTML = `<i class="fa-solid ${icon}"></i> <span class="text-sm font-semibold text-white">${msg}</span>`;
                
                box.appendChild(el);
                setTimeout(() => el.remove(), 3000);
            }
        };

        // Auth Logic (Simulation)
        const Auth = {
            toggle(target) {
                SFX.click();
                const login = document.getElementById('login-box');
                const register = document.getElementById('register-box');

                if (target === 'register') {
                    login.classList.add('hidden');
                    register.classList.remove('hidden');
                    register.classList.add('switch-enter');
                } else {
                    register.classList.add('hidden');
                    login.classList.remove('hidden');
                    login.classList.add('switch-enter');
                }
            },
            login() {
                SFX.success();
                // Simulate Login
                document.getElementById('auth-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-screen').classList.remove('hidden');
                    // Trigger reflow
                    void document.getElementById('app-screen').offsetWidth;
                    document.getElementById('app-screen').style.opacity = '1';
                    
                    // Check API
                    if(!localStorage.getItem('gemini_api_key')) {
                        document.getElementById('api-alert').classList.remove('hidden');
                    }
                }, 500);
            },
            register() {
                SFX.success();
                Toast.show('Account created successfully!', 'success');
                this.toggle('login');
            }
        };

        // Settings Logic
        const Settings = {
            open() {
                SFX.click();
                document.getElementById('settings-modal').classList.remove('hidden');
                document.getElementById('api-key-input').value = localStorage.getItem('gemini_api_key') || '';
            },
            close() {
                SFX.click();
                document.getElementById('settings-modal').classList.add('hidden');
            },
            save() {
                const key = document.getElementById('api-key-input').value.trim();
                if(key) {
                    localStorage.getItem('gemini_api_key', key);
                    localStorage.setItem('gemini_api_key', key);
                    Toast.show('API Key Saved!', 'success');
                    document.getElementById('api-alert').classList.add('hidden');
                    this.close();
                } else {
                    Toast.show('Please enter a valid key', 'error');
                }
            }
        };

        // App State
        const App = {
            currentPair: 'XAUUSD',
            currentImage: null,

            setPair(pair, isCustom = false) {
                SFX.click();
                this.currentPair = pair;
                
                // UI Update
                document.querySelectorAll('.pair-btn').forEach(btn => {
                    btn.classList.remove('bg-slate-800', 'border-cyan-500', 'text-cyan-400', 'shadow-[0_0_10px_rgba(0,240,255,0.2)]');
                    btn.classList.add('bg-slate-800/50', 'border-slate-700', 'text-slate-400');
                    if(btn.innerText === pair) {
                         btn.classList.remove('bg-slate-800/50', 'border-slate-700', 'text-slate-400');
                         btn.classList.add('bg-slate-800', 'border-cyan-500', 'text-cyan-400', 'shadow-[0_0_10px_rgba(0,240,255,0.2)]');
                    }
                });

                if(!isCustom && pair !== '') document.getElementById('custom-pair').value = "";
                Toast.show(`Target set: ${pair}`);
            },

            handleFile(file) {
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentImage = e.target.result.split(',')[1];
                    const img = document.getElementById('img-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('upload-ui').classList.add('hidden');
                    document.getElementById('btn-remove-img').classList.remove('hidden');
                    SFX.success();
                };
                reader.readAsDataURL(file);
            },

            clearImage() {
                SFX.click();
                this.currentImage = null;
                document.getElementById('img-preview').classList.add('hidden');
                document.getElementById('upload-ui').classList.remove('hidden');
                document.getElementById('file-input').value = '';
                document.getElementById('btn-remove-img').classList.add('hidden');
            }
        };

        // File Input Listeners
        document.getElementById('file-input').addEventListener('change', (e) => App.handleFile(e.target.files[0]));
        // Drag & Drop
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-cyan-500'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('border-cyan-500'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-cyan-500');
            if(e.dataTransfer.files[0]) App.handleFile(e.dataTransfer.files[0]);
        });


        // --- 4. AI ENGINE (Gemini Vision) ---
        const AI = {
            data: null, // Store result
            lang: 'th',

            async analyze() {
                const apiKey = localStorage.getItem('gemini_api_key');
                if(!apiKey) return Settings.open();
                if(!App.currentImage) return Toast.show('Please upload a chart image', 'error');

                SFX.click();
                SFX.scan();
                
                // UI Loading
                const btn = document.getElementById('btn-analyze');
                btn.disabled = true;
                btn.innerHTML = '<span class="flex items-center gap-2"><i class="fa-solid fa-satellite-dish fa-spin"></i> CONNECTING AI...</span>';
                document.getElementById('scanner-line').style.display = 'block';
                document.getElementById('scanner-overlay').style.display = 'block';
                document.getElementById('result-container').classList.add('hidden');

                try {
                    const prompt = `
                        Analyze this trading chart for ${App.currentPair}. You are a professional trader.
                        Identify Trend, Entry, SL, TP, and Zones.
                        Response strictly in JSON format (no markdown):
                        {
                            "action": "BUY" or "SELL" or "WAIT",
                            "confidence": "80-99",
                            "entry": "Price",
                            "sl": "Price",
                            "tp": "Price",
                            "rr": "Risk:Reward (e.g. 1:2.5)",
                            "buy_zone": "Price Range",
                            "sell_zone": "Price Range",
                            "reason_th": "Thai explanation (max 25 words)",
                            "reason_en": "English explanation (max 25 words)"
                        }
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inline_data: { mime_type: "image/jpeg", data: App.currentImage } }
                                ]
                            }]
                        })
                    });

                    const json = await response.json();
                    
                    // Parse Logic
                    if(json.error) throw new Error(json.error.message);
                    
                    const text = json.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    this.data = JSON.parse(text);
                    
                    this.render();
                    SFX.success();

                } catch (err) {
                    console.error(err);
                    SFX.error();
                    Toast.show('Analysis Failed. Check API Key or Image.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="relative z-10 flex items-center justify-center gap-3"><i class="fa-solid fa-microchip"></i> Analyze Market</span>';
                    document.getElementById('scanner-line').style.display = 'none';
                    document.getElementById('scanner-overlay').style.display = 'none';
                }
            },

            render() {
                if(!this.data) return;
                
                const d = this.data;
                const container = document.getElementById('result-container');
                const head = document.getElementById('res-header');
                const bar = document.getElementById('res-bar');
                
                // Color mapping
                let color = 'text-slate-200';
                let glow = '0,0,0';
                let barColor = 'bg-slate-500';

                if(d.action === 'BUY') { color = 'text-green-400'; glow = '0, 255, 163'; barColor = 'bg-green-500'; }
                if(d.action === 'SELL') { color = 'text-red-400'; glow = '255, 0, 60'; barColor = 'bg-red-500'; }
                if(d.action === 'WAIT') { color = 'text-yellow-400'; glow = '250, 204, 21'; barColor = 'bg-yellow-500'; }

                // Inject Data
                document.getElementById('res-pair').innerText = App.currentPair;
                const actionEl = document.getElementById('res-action');
                actionEl.innerText = d.action;
                actionEl.className = `text-5xl font-bold font-tech ${color} drop-shadow-[0_0_15px_rgba(${glow},0.5)]`;
                
                document.getElementById('res-conf').innerText = d.confidence + "% Confidence";
                document.getElementById('res-entry').innerText = d.entry;
                document.getElementById('res-rr').innerText = d.rr;
                document.getElementById('res-sl').innerText = d.sl;
                document.getElementById('res-tp').innerText = d.tp;
                document.getElementById('res-z-buy').innerText = d.buy_zone;
                document.getElementById('res-z-sell').innerText = d.sell_zone;
                
                bar.className = `absolute top-0 left-0 w-full h-1 ${barColor} shadow-[0_0_10px_rgba(${glow},0.8)]`;

                this.updateText();

                // Show
                container.classList.remove('hidden');
                // Animation triggers
                setTimeout(() => {
                    container.classList.remove('opacity-0', 'translate-y-10');
                    container.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            },

            toggleLang() {
                SFX.click();
                this.lang = this.lang === 'th' ? 'en' : 'th';
                this.updateText();
            },

            updateText() {
                if(!this.data) return;
                const text = this.lang === 'th' ? this.data.reason_th : this.data.reason_en;
                document.getElementById('res-reason').innerText = text;
            }
        };

        // --- INITIALIZE SOUND INTERACTION ---
        // Browsers block audio context until user interacts
        document.body.addEventListener('click', () => {
            if (SFX.ctx.state === 'suspended') SFX.ctx.resume();
        }, { once: true });

    </script>
</body>
</html>
