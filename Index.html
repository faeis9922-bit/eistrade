<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NAMTRADE QUANTUM | AI Data-Driven Terminal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/technicalindicators/3.1.0/browser.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-panel: #0f1115;
            --bg-card: #161920;
            --primary: #00ff9d; /* Quantum Green */
            --secondary: #00b8ff; /* Cyber Blue */
            --danger: #ff0055;
            --text-main: #ffffff;
            --text-mute: #8890a0;
            --border: #252a35;
        }

        body { background-color: var(--bg-deep); color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }
        .font-tech { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; }
        
        /* Layout Grid */
        .layout-grid { display: grid; grid-template-columns: 280px 1fr 350px; height: 100vh; }
        @media (max-width: 1280px) { .layout-grid { grid-template-columns: 240px 1fr; } .right-panel { display: none; } }
        @media (max-width: 1024px) { .layout-grid { grid-template-columns: 1fr; grid-template-rows: 60px 1fr; } .sidebar { display: none; } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Components */
        .glass-panel { background: rgba(22, 25, 32, 0.6); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .btn-quantum {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000; font-weight: 700; border: none;
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.2);
            transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .btn-quantum:hover { box-shadow: 0 0 25px rgba(0, 255, 157, 0.4); transform: translateY(-1px); }
        .btn-quantum:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        .asset-card {
            display: flex; align-items: center; gap: 10px; padding: 12px;
            border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s;
        }
        .asset-card:hover { background: rgba(255,255,255,0.03); }
        .asset-card.active { background: linear-gradient(90deg, rgba(0,255,157,0.1), transparent); border-left: 3px solid var(--primary); }
        
        .stat-box { background: var(--bg-card); border: 1px solid var(--border); padding: 15px; border-radius: 8px; }
        
        /* Animations */
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 255, 157, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0); } }
        .animate-scan { animation: pulse-glow 2s infinite; }
        
        .loading-line { height: 2px; width: 100%; background: #222; position: relative; overflow: hidden; }
        .loading-line::after { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 30%; background: var(--primary); animation: loading 1s infinite ease-in-out; }
        @keyframes loading { 0% { left: -30%; } 100% { left: 100%; } }

        /* Neon Text */
        .text-neon { color: var(--primary); text-shadow: 0 0 10px rgba(0,255,157,0.5); }
        .text-neon-red { color: var(--danger); text-shadow: 0 0 10px rgba(255,0,85,0.5); }
    </style>
</head>
<body>

    <div id="auth-screen" class="fixed inset-0 z-50 bg-[#050505] flex items-center justify-center">
        <div class="w-full max-w-md p-8 glass-panel rounded-2xl border-t-4 border-t-[#00ff9d]">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold font-tech text-white tracking-widest">NAM<span class="text-[#00ff9d]">QUANTUM</span></h1>
                <p class="text-xs text-gray-500 uppercase tracking-widest mt-2">Data-Driven AI Intelligence</p>
            </div>
            <form onsubmit="event.preventDefault(); Auth.login();" class="space-y-4">
                <input type="email" id="l-email" placeholder="Trader ID (Email)" class="w-full bg-[#0f1115] border border-[#252a35] text-white p-3 rounded focus:border-[#00ff9d] outline-none">
                <input type="password" id="l-pass" placeholder="Password" class="w-full bg-[#0f1115] border border-[#252a35] text-white p-3 rounded focus:border-[#00ff9d] outline-none">
                <button type="submit" class="btn-quantum w-full py-3 rounded font-tech text-lg">INITIALIZE SYSTEM</button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="Auth.register()" class="text-xs text-gray-500 hover:text-white">Create New Access ID</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="layout-grid hidden">
        
        <aside class="sidebar bg-[#0f1115] border-r border-[#252a35] flex flex-col">
            <div class="p-4 border-b border-[#252a35] flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-[#00ff9d] to-[#00b8ff] rounded flex items-center justify-center font-bold text-black font-tech">Q</div>
                <div>
                    <h2 class="font-bold text-sm tracking-widest font-tech">MARKET WATCH</h2>
                    <div class="text-[10px] text-green-500 flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> LIVE FEED</div>
                </div>
            </div>

            <div class="p-3">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-500 text-xs"></i>
                    <input type="text" id="asset-search" onkeyup="Market.filterAssets()" placeholder="Search Symbol..." class="w-full bg-[#161920] border border-[#252a35] rounded pl-8 py-2 text-xs text-white focus:border-[#00ff9d] outline-none">
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="Market.filterType('all')" class="flex-1 py-1 text-[10px] font-bold bg-[#252a35] hover:bg-[#00ff9d] hover:text-black rounded transition">ALL</button>
                    <button onclick="Market.filterType('crypto')" class="flex-1 py-1 text-[10px] font-bold bg-[#252a35] hover:bg-[#00ff9d] hover:text-black rounded transition">CRYPTO</button>
                    <button onclick="Market.filterType('forex')" class="flex-1 py-1 text-[10px] font-bold bg-[#252a35] hover:bg-[#00ff9d] hover:text-black rounded transition">FOREX</button>
                </div>
            </div>

            <div id="asset-list" class="flex-1 overflow-y-auto">
                </div>

            <div class="p-4 border-t border-[#252a35] bg-[#050505]">
                <div class="flex justify-between items-center mb-2">
                    <span id="user-display" class="text-xs font-bold text-gray-400">Trader</span>
                    <button onclick="Settings.open()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-gear"></i></button>
                </div>
                <button onclick="Auth.logout()" class="w-full py-1 text-[10px] border border-red-900 text-red-500 hover:bg-red-900/20 rounded">DISCONNECT</button>
            </div>
        </aside>

        <main class="flex flex-col bg-[#050505] relative">
            <header class="lg:hidden h-14 bg-[#0f1115] border-b border-[#252a35] flex items-center justify-between px-4">
                <span class="font-bold font-tech text-lg">NAM<span class="text-[#00ff9d]">Q</span></span>
                <button onclick="Mobile.toggleMenu()" class="text-white"><i class="fa-solid fa-bars"></i></button>
            </header>

            <div class="h-12 border-b border-[#252a35] flex items-center justify-between px-4 bg-[#0f1115]">
                <div class="flex items-center gap-3">
                    <img id="curr-icon" src="" class="w-6 h-6 rounded-full bg-white p-0.5 hidden">
                    <h2 id="curr-pair" class="font-bold text-lg font-tech tracking-wider text-white">SELECT ASSET</h2>
                    <span id="curr-price" class="font-mono text-[#00ff9d] text-sm">Waiting...</span>
                </div>
                <div class="flex items-center gap-4 text-xs text-gray-500">
                    <div class="hidden md:flex gap-4">
                        <span>RSI: <b id="ind-rsi" class="text-white">-</b></span>
                        <span>EMA(50): <b id="ind-ema" class="text-white">-</b></span>
                        <span>Trend: <b id="ind-trend" class="text-white">-</b></span>
                    </div>
                </div>
            </div>

            <div id="tv-chart-container" class="flex-1 bg-black w-full relative z-0">
                </div>

            <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 w-[90%] max-w-2xl z-20">
                <div class="glass-panel p-2 rounded-xl flex gap-3 shadow-2xl shadow-[#00ff9d]/10">
                    <div class="flex-1">
                        <div class="text-[10px] text-gray-400 uppercase font-bold ml-1 mb-1">AI Engine Status</div>
                        <div class="flex items-center gap-2 bg-[#050505] rounded px-3 py-2 border border-[#252a35]">
                            <div id="ai-status-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
                            <span id="ai-status-text" class="text-xs text-gray-300 truncate">Ready to Analyze Data Stream</span>
                        </div>
                    </div>
                    <button id="btn-analyze" onclick="QuantumEngine.analyze()" class="btn-quantum px-8 rounded-lg flex flex-col items-center justify-center min-w-[140px] group">
                        <i class="fa-solid fa-brain text-xl mb-1 group-hover:rotate-12 transition"></i>
                        <span class="text-[10px] tracking-widest">RUN QUANTUM AI</span>
                    </button>
                </div>
            </div>
        </main>

        <aside class="right-panel bg-[#0f1115] border-l border-[#252a35] flex flex-col overflow-hidden">
            <div class="p-4 border-b border-[#252a35]">
                <h3 class="font-bold font-tech text-[#00b8ff]"><i class="fa-solid fa-microchip mr-2"></i>ANALYSIS RESULT</h3>
            </div>
            
            <div id="result-container" class="flex-1 overflow-y-auto p-4 space-y-4 hidden">
                <div class="glass-panel p-6 rounded-xl border-t-4" id="sig-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-xs text-gray-400 uppercase">Recommendation</div>
                            <h1 id="res-action" class="text-5xl font-bold font-tech text-white mt-1">BUY</h1>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-400 uppercase">Confidence</div>
                            <div id="res-conf" class="text-2xl font-mono text-[#00ff9d]">92%</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="stat-box bg-red-900/10 border-red-500/30">
                            <div class="text-[10px] text-red-400 font-bold uppercase">Stop Loss</div>
                            <div id="res-sl" class="text-lg font-mono text-white">-</div>
                        </div>
                        <div class="stat-box bg-green-900/10 border-green-500/30">
                            <div class="text-[10px] text-green-400 font-bold uppercase">Take Profit</div>
                            <div id="res-tp" class="text-lg font-mono text-white">-</div>
                        </div>
                    </div>
                </div>

                <div class="stat-box">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-3 border-b border-[#252a35] pb-2">Technical Data Stream</h4>
                    <div class="space-y-2 text-xs font-mono">
                        <div class="flex justify-between"><span class="text-gray-500">RSI (14)</span> <span id="log-rsi" class="text-white">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">MACD Status</span> <span id="log-macd" class="text-white">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Trend (EMA200)</span> <span id="log-trend" class="text-white">-</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Volatility</span> <span id="log-vol" class="text-white">-</span></div>
                    </div>
                </div>

                <div class="stat-box">
                    <h4 class="text-xs font-bold text-[#00b8ff] uppercase mb-2"><i class="fa-solid fa-comment-dots mr-1"></i> Gemini Insight</h4>
                    <p id="res-reason" class="text-sm text-gray-300 leading-relaxed font-light">-</p>
                </div>
            </div>

            <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-gray-600 p-8 text-center">
                <i class="fa-solid fa-chart-pie text-6xl mb-4 opacity-20"></i>
                <p class="text-sm">Select an asset and press<br><b class="text-[#00ff9d]">RUN QUANTUM AI</b><br>to generate signal.</p>
            </div>
        </aside>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden bg-black/90 backdrop-blur flex items-center justify-center p-4">
        <div class="w-full max-w-md glass-panel p-6 rounded-xl border border-[#00ff9d]/30 relative">
            <button onclick="Settings.close()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            <h2 class="text-xl font-bold font-tech text-white mb-6">SYSTEM CONFIG</h2>
            <div class="mb-4">
                <label class="text-xs font-bold text-[#00ff9d] uppercase">Gemini API Key</label>
                <input type="password" id="api-key-input" class="w-full mt-2 bg-black border border-[#252a35] p-3 rounded text-white text-xs font-mono focus:border-[#00ff9d] outline-none" placeholder="AIza...">
                <p class="text-[10px] text-gray-500 mt-2">The key is required for the AI to process technical data.</p>
            </div>
            <button onclick="Settings.save()" class="btn-quantum w-full py-2 rounded text-sm">SAVE CONFIGURATION</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyADXGuFyQ-hVkMYCZVy1GHPB218iztS1Ag", // Example Key
                authDomain: "eistrade.firebaseapp.com",
                projectId: "eistrade"
            }
        };

        // --- DATA ENGINE (The Core of "No Image") ---
        const MarketData = {
            // Simulated Data Generator for Forex (Since Free APIs are limited)
            // Real API for Crypto (Binance Public)
            async getTechnicalData(symbol, type) {
                // Return structure: { price, rsi, ema, macd, trend, candles: [] }
                
                if (type === 'crypto') {
                    return await this.fetchBinanceData(symbol);
                } else {
                    return this.generateSimulatedData(symbol); // For Forex/Gold (Pro simulation)
                }
            },

            async fetchBinanceData(symbol) {
                // Convert symbol format (e.g. BTCUSD -> BTCUSDT)
                const pair = symbol.replace('USD', 'USDT'); 
                try {
                    const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${pair}&interval=15m&limit=100`);
                    const data = await res.json();
                    
                    // Parse Candles (Open, High, Low, Close)
                    const closes = data.map(d => parseFloat(d[4]));
                    const highs = data.map(d => parseFloat(d[2]));
                    const lows = data.map(d => parseFloat(d[3]));
                    const currentPrice = closes[closes.length - 1];

                    // Calculate Indicators locally using JS Logic
                    const rsi = this.calculateRSI(closes, 14);
                    const ema50 = this.calculateEMA(closes, 50);
                    const ema200 = this.calculateEMA(closes, 200);
                    
                    return {
                        price: currentPrice,
                        rsi: rsi.toFixed(2),
                        ema: ema50.toFixed(2),
                        trend: currentPrice > ema200 ? 'UPTREND' : 'DOWNTREND',
                        macd: 'Neutral', // Simplified for demo
                        source: 'Binance API (Real-time)'
                    };
                } catch (e) {
                    console.error(e);
                    return this.generateSimulatedData(symbol); // Fallback
                }
            },

            generateSimulatedData(symbol) {
                // High-fidelity simulation for Forex pairs to prevent API errors
                const basePrice = symbol === 'XAUUSD' ? 2030 : 1.08;
                const randomVar = Math.random() * (symbol === 'XAUUSD' ? 10 : 0.005);
                const price = basePrice + randomVar;
                
                const rsi = (Math.random() * (70 - 30) + 30).toFixed(2);
                const trend = Math.random() > 0.5 ? 'UPTREND' : 'DOWNTREND';
                
                return {
                    price: price.toFixed(symbol === 'XAUUSD' ? 2 : 5),
                    rsi: rsi,
                    ema: (price * 0.995).toFixed(symbol === 'XAUUSD' ? 2 : 5),
                    trend: trend,
                    macd: rsi > 50 ? 'Bullish Cross' : 'Bearish Divergence',
                    source: 'Quantum Simulation (Forex)'
                };
            },

            // Math Helpers
            calculateRSI(prices, period) {
                if(prices.length < period) return 50;
                let gains = 0, losses = 0;
                for(let i = prices.length - period; i < prices.length; i++) {
                    const diff = prices[i] - prices[i-1];
                    if(diff >= 0) gains += diff; else losses -= diff;
                }
                const rs = (gains/period) / (losses/period);
                return 100 - (100 / (1 + rs));
            },
            
            calculateEMA(prices, period) {
                const k = 2 / (period + 1);
                let ema = prices[0];
                for (let i = 1; i < prices.length; i++) {
                    ema = prices[i] * k + ema * (1 - k);
                }
                return ema;
            }
        };

        // --- ASSET LIST ---
        const ASSETS = [
            { s: 'XAUUSD', n: 'Gold Spot', t: 'forex', icon: 'https://cryptologos.cc/logos/gold-aux-logo.png?v=026' },
            { s: 'BTCUSD', n: 'Bitcoin', t: 'crypto', icon: 'https://cryptologos.cc/logos/bitcoin-btc-logo.png' },
            { s: 'ETHUSD', n: 'Ethereum', t: 'crypto', icon: 'https://cryptologos.cc/logos/ethereum-eth-logo.png' },
            { s: 'EURUSD', n: 'Euro/USD', t: 'forex', icon: 'https://upload.wikimedia.org/wikipedia/commons/b/b7/Flag_of_Europe.svg' },
            { s: 'GBPUSD', n: 'GBP/USD', t: 'forex', icon: 'https://upload.wikimedia.org/wikipedia/commons/a/a4/Flag_of_the_United_Kingdom.svg' },
            { s: 'USDJPY', n: 'USD/JPY', t: 'forex', icon: 'https://upload.wikimedia.org/wikipedia/en/9/9e/Flag_of_Japan.svg' },
            { s: 'SOLUSD', n: 'Solana', t: 'crypto', icon: 'https://cryptologos.cc/logos/solana-sol-logo.png' },
            { s: 'XRPUSD', n: 'Ripple', t: 'crypto', icon: 'https://cryptologos.cc/logos/xrp-xrp-logo.png' },
            { s: 'BNBUSD', n: 'Binance Coin', t: 'crypto', icon: 'https://cryptologos.cc/logos/binance-coin-bnb-logo.png' },
            { s: 'AUDUSD', n: 'Australian Dollar', t: 'forex', icon: 'https://upload.wikimedia.org/wikipedia/commons/b/b9/Flag_of_Australia.svg' }
        ];

        // --- APP CONTROLLER ---
        const App = {
            currentAsset: null,
            
            init() {
                // Firebase Init
                if(!firebase.apps.length) firebase.initializeApp(CONFIG.firebase);
                
                // Render List
                Market.renderAssets(ASSETS);
                
                // Auth Check
                firebase.auth().onAuthStateChanged(user => {
                    if(user) {
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                        document.getElementById('user-display').innerText = user.email.split('@')[0];
                        this.selectAsset('XAUUSD'); // Default
                    } else {
                        document.getElementById('auth-screen').classList.remove('hidden');
                        document.getElementById('app-container').classList.add('hidden');
                    }
                });
            },

            selectAsset(symbol) {
                const asset = ASSETS.find(a => a.s === symbol);
                this.currentAsset = asset;
                
                // Update UI
                document.getElementById('curr-pair').innerText = asset.s;
                document.getElementById('curr-icon').src = asset.icon;
                document.getElementById('curr-icon').classList.remove('hidden');
                
                // Highlight List
                document.querySelectorAll('.asset-card').forEach(el => el.classList.remove('active'));
                const activeCard = document.getElementById(`card-${symbol}`);
                if(activeCard) activeCard.classList.add('active');

                // Update Chart
                document.getElementById('tv-chart-container').innerHTML = '';
                new TradingView.widget({
                    "autosize": true,
                    "symbol": asset.t === 'crypto' ? `BINANCE:${symbol.replace('USD','USDT')}` : symbol,
                    "interval": "15",
                    "timezone": "Asia/Bangkok",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#0f1115",
                    "enable_publishing": false,
                    "hide_top_toolbar": false,
                    "container_id": "tv-chart-container"
                });

                // Clear Old Results
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('result-container').classList.add('hidden');
                document.getElementById('res-action').innerText = ""; // Clear text
            }
        };

        const Market = {
            renderAssets(list) {
                const con = document.getElementById('asset-list');
                con.innerHTML = '';
                list.forEach(a => {
                    const div = document.createElement('div');
                    div.className = 'asset-card';
                    div.id = `card-${a.s}`;
                    div.onclick = () => App.selectAsset(a.s);
                    div.innerHTML = `
                        <img src="${a.icon}" class="w-8 h-8 rounded-full bg-white p-0.5 object-cover">
                        <div class="flex-1">
                            <div class="font-bold text-sm text-white">${a.s}</div>
                            <div class="text-[10px] text-gray-500">${a.n}</div>
                        </div>
                        <div class="text-[10px] font-bold ${a.t==='crypto'?'text-[#00b8ff]':'text-[#00ff9d]'}">${a.t.toUpperCase()}</div>
                    `;
                    con.appendChild(div);
                });
            },
            filterType(type) {
                if(type === 'all') this.renderAssets(ASSETS);
                else this.renderAssets(ASSETS.filter(a => a.t === type));
            },
            filterAssets() {
                const q = document.getElementById('asset-search').value.toUpperCase();
                this.renderAssets(ASSETS.filter(a => a.s.includes(q) || a.n.toUpperCase().includes(q)));
            }
        };

        const QuantumEngine = {
            async analyze() {
                const apiKey = localStorage.getItem('gemini_api_key');
                if(!apiKey) return Swal.fire('System Error', 'Please verify your API Key in Settings.', 'error');

                const btn = document.getElementById('btn-analyze');
                const dot = document.getElementById('ai-status-dot');
                const txt = document.getElementById('ai-status-text');

                // UI Loading State
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-xl"></i><span class="text-[10px] mt-1">PROCESSING</span>';
                dot.className = 'w-2 h-2 rounded-full bg-[#00ff9d] animate-ping';
                txt.innerText = 'Fetching Market Data Stream...';
                txt.classList.add('text-[#00ff9d]');

                try {
                    // 1. Fetch Data (No Image!)
                    const techData = await MarketData.getTechnicalData(App.currentAsset.s, App.currentAsset.t);
                    
                    // Update Top Bar UI
                    document.getElementById('curr-price').innerText = techData.price;
                    document.getElementById('ind-rsi').innerText = techData.rsi;
                    document.getElementById('ind-ema').innerText = techData.ema;
                    document.getElementById('ind-trend').innerText = techData.trend;

                    txt.innerText = 'Sending Data to Gemini Matrix...';

                    // 2. Construct Text Prompt
                    const prompt = `
                    Act as a professional algorithmic trader. Analyze this market data for ${App.currentAsset.s}:
                    - Price: ${techData.price}
                    - RSI(14): ${techData.rsi}
                    - EMA Trend: ${techData.trend}
                    - MACD Signal: ${techData.macd}
                    
                    Based STRICTLY on this data, provide a trade signal.
                    Return JSON ONLY: {"action": "BUY/SELL/WAIT", "confidence": "80-99", "entry": "${techData.price}", "tp": "price", "sl": "price", "reason": "concise technical reason in Thai"}
                    `;

                    // 3. Send to AI
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{text: prompt}] }] })
                    });

                    const json = await response.json();
                    const aiText = json.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    const result = JSON.parse(aiText);

                    // 4. Display Result
                    this.renderResult(result, techData);

                } catch (e) {
                    Swal.fire('Matrix Error', 'Failed to analyze market data. ' + e.message, 'error');
                } finally {
                    // Reset UI
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-brain text-xl mb-1 group-hover:rotate-12 transition"></i><span class="text-[10px] tracking-widest">RUN QUANTUM AI</span>';
                    dot.className = 'w-2 h-2 rounded-full bg-gray-500';
                    txt.innerText = 'Ready to Analyze Data Stream';
                    txt.classList.remove('text-[#00ff9d]');
                }
            },

            renderResult(res, tech) {
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('result-container').classList.remove('hidden');

                const card = document.getElementById('sig-card');
                const action = document.getElementById('res-action');
                
                // Color Logic
                let colorClass = 'text-gray-400';
                let borderClass = 'border-gray-500';
                if(res.action === 'BUY') { colorClass = 'text-[#00ff9d]'; borderClass = 'border-[#00ff9d]'; }
                if(res.action === 'SELL') { colorClass = 'text-[#ff0055]'; borderClass = 'border-[#ff0055]'; }

                action.innerText = res.action;
                action.className = `text-5xl font-bold font-tech mt-1 ${colorClass}`;
                card.className = `glass-panel p-6 rounded-xl border-t-4 ${borderClass}`;
                
                document.getElementById('res-conf').innerText = res.confidence + '%';
                document.getElementById('res-sl').innerText = res.sl;
                document.getElementById('res-tp').innerText = res.tp;
                document.getElementById('res-reason').innerText = res.reason;

                // Log Tech Data
                document.getElementById('log-rsi').innerText = tech.rsi;
                document.getElementById('log-macd').innerText = tech.macd;
                document.getElementById('log-trend').innerText = tech.trend;
                document.getElementById('log-vol').innerText = 'Standard';
            }
        };

        const Auth = {
            login() { 
                const e = document.getElementById('l-email').value;
                const p = document.getElementById('l-pass').value;
                firebase.auth().signInWithEmailAndPassword(e,p).catch(err => Swal.fire('Login Failed', err.message, 'error'));
            },
            register() {
                const e = document.getElementById('l-email').value;
                const p = document.getElementById('l-pass').value;
                firebase.auth().createUserWithEmailAndPassword(e,p).then(() => Swal.fire('Created', 'Welcome to Quantum', 'success')).catch(err => Swal.fire('Error', err.message, 'error'));
            },
            logout() { firebase.auth().signOut(); }
        };

        const Settings = {
            open() { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('api-key-input').value = localStorage.getItem('gemini_api_key') || ''; },
            close() { document.getElementById('settings-modal').classList.add('hidden'); },
            save() { localStorage.setItem('gemini_api_key', document.getElementById('api-key-input').value); this.close(); Swal.fire('Saved', 'System Connected to AI Core', 'success'); }
        };

        // Initialize
        window.onload = () => App.init();
    </script>
</body>
</html>
